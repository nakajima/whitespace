#!/usr/bin/env ruby

# script/whitespace
#
# Strips whitespace from any files modified in git
# Also:
# - converts tabs to spaces
# - ensures a single newline at the end
FILE_TYPES = "rb|js|haml|html|css|sass|coffee"

class WhitespaceProcessor
  def self.process(code)
    result = []
    code.each_line do |line|
      line.gsub!(/(\s+)$/, "\n")
      line.gsub!(/\t/, '  ')
      result << line
    end

    while result.last =~ /^$/
      result.pop
    end

    unless result.last =~ /\n$/
      result << "\n"
    end

    code = result.join
    code.gsub!(/\A\n*/, '')
    code
  end
end

@message_all = "* Stripping whitespace from all project files."
@message_modified = "* Stripping whitespace from modified files."


def get_files_git
  if ARGV.include?('--all')
    puts @message_all 
    `find . -type file | grep -v .git | grep -v ./vendor | grep -v ./tmp  | egrep ".(#{FILE_TYPES})"`.split(/\n/)
  else
    puts @message_modified 
    `git status | egrep ".(#{FILE_TYPES})"`.split("\n").select { |file| file =~ /^#\t(modified|new file|renamed):/ }
  end
end

def get_files_mercurial
  if ARGV.include?('--all')
    puts @message_all 
    `hg status -m -a -c -n`.split("\n").select { |file| file =~ /\.(#{FILE_TYPES})$/ }
  else
    puts @message_modified 
    `hg status -m -a -n`.split("\n").select { |file| file =~ /^[^!I?].*\.(#{FILE_TYPES})$/ }
  end
end

if ARGV.include?('--hg')
  files = get_files_mercurial
else
  files = get_files_git
end

files.each do |line|
  line = line.split(":").last.strip
  puts "  processing #{line}..."
  code = File.read(line)
  File.open(line, 'w+') { |f| f << (WhitespaceProcessor.process(code)) }
end
puts "* DONE"
